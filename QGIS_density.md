# Визуализация плотности населения в QGIS

У меня QGIS на английском, так что в некоторых местах не уверен в переводе.

## 1. Введение  
У нас должна быть следующая информация:  
#### 1. Численность населения  
1. [БДПМО](https://www.gks.ru/dbscripts/munst/)
2. Иные источники данных, например, сайт муниципального образования или [сайт Росстата](https://rosstat.gov.ru/folder/12781)
#### 2. Площадь жилых помещений в отдельных домах  
1. Для МКД — [«Реформа.ЖКХ»](https://www.reformagkh.ru/opendata?gid=2208161&cids=house_management&page=1&pageSize=10)  
2. Для ИЖС — см. [ниже](https://github.com/a-berez/QGIS-and-other/blob/main/QGIS_density.md#4-ижс)  
#### 3. Общая площадь жилого фонда
1. Для МКД — [БДПМО](https://www.gks.ru/dbscripts/munst/)  
2. Для ИЖС — [ниже](https://github.com/a-berez/QGIS-and-other/blob/main/QGIS_density.md#4-ижс)  
#### 4. Список домов ИЖС
1. Запрос в калькулятор выделения `"BUILDING" =  'detached' OR "BUILDING" = 'house' OR "BUILDING" = 'residential' OR NULL` и перепроверка  

## 2. Загрузка данных с «Реформы.ЖКХ» в QGIS.  
!Про присоединение элементов описано [здесь](https://github.com/a-berez/QGIS-and-other/blob/main/QGIS_joining.md)!
#### 1. Загружаем геокодированные данные в формате CSV.  
!Лучше сохранять какой-либо уникальный элемент в наборе данных, например, ID или присовить свой!  

Слой → Добавить слой → delimited text layer или ctrl/cmd+Shift+T  

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density1.png)  
 
[1] — выбираем файл, который надо загрузить  
[2] — выбираем разделитель. Чаще всего это точка с запятой, но могут быть исключения. При выборе нужно ориентироваться на окошко предпросмотра  
[3] — Нужно отметить: первая строка как заголовок, цеплять типы полей, отбрасывать пустые поля, (если не изменены запятые на точки в п. 2) запятая как десятичный разделитель  
[4] — очевидно  
[5] — окно предпросмотра  

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density2.png)  

Проверив всё, нажимаем «Добавить» и смотрим, загрузилась ли таблица атрибутов.  

#### 2. Запускаем инструмент «Join attributes by location».  

[1] — слой, **к которому** надо присоединить  
[2] — слой, **который** надо присоединить  
[3] — настройки «совпадения» (подробнее [здесь](https://gis.stackexchange.com/a/305193))  
[4] — слои, которые надо присоединить  

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density3.png)  

Запускаем инструмент и проверяем, всё ли корректно присоединилось. Если нет, то либо корректируем настройки, либо перетаскиваем точки вручную на полигоны. 

Проверяем, чтобы нужное нам значение имело числовой формат (обычно integer). 

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density4.png)  

Теперь у нас есть полигоны зданий с данными о площади жилых помещений в них.  

## 3. Расчёт населения каждого дома  

Для этого нам нужно провести следующие вычисления в калькуляторе полей:   
[1] — снятая галочка означает применение ко всем строкам  
[2] — создаём новый столбец и называем его (на латинице!)  
[3] — выбираем тип поля real (десятичные значения)  
[4] — выражение (о нём [ниже](https://github.com/a-berez/QGIS-and-other/blob/main/QGIS_density.md#про-выражение))   
[5] — предпросмотр (не должно быть красного!)  

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density5.png)   

#### Про выражение   
Составим пропорцию:
```math
\frac{P_{city}}{P_{house}}=\frac{S_{city}}{S_{house}}\Rightarrow P_{house}=\frac{P_{city}×S_{house}}{S_{city}}
```  

Где  
$`P_{city}`$ — общее количество жителей в городе;  
$`P_{house}`$ — количество жителей в доме;  
$`S_{city}`$ — общая жилая площадь в МКД в городе;  
$`S_{house}`$ — жилая площадь в доме.   

## 4. ИЖС  
Здесь есть два варианта. Более точный и более быстрый. Хотя у обоих точность, на самом деле, не так хороша.   

#### Быстрый   
1. Выделяем дома ИЖС с помощью калькулятора выделений   
2. После этого в калькуляторе добавляем к данным, которые мы получили в [п. 3](https://github.com/a-berez/QGIS-and-other/blob/main/QGIS_density.md#3-расчёт-населения-каждого-дома) примерное значение средней численности жителей таких домов (обычно, где-то между 2 и 3)

[1] — обновляем только выделенные   
[2] — обновляем столбец, а не создаём   
[3] — ставим значение   

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density6.png)  

#### Более точный    
1. Выделяем дома ИЖС с помощью калькулятора выделения   
2. Обновляем столбец с жилой площадью, прописывая выражение `$area`. Это позволит узнать нам площадь «подошвы» здания, которую мы и примем за жилую (поскольку площадь дома не всегда равна жилой площади внутри него, а стены тоже имеют свою толщину, при желании можно скорректировать, применив понижающий коэффициент — обычно ~0,7)  
3. Используя статистическое саммари, узнаём сумму населения, вычисленную в [п. 3](https://github.com/a-berez/QGIS-and-other/blob/main/QGIS_density.md#3-расчёт-населения-каждого-дома)     

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density7.png)    

4. В саммари выбираем слой и поле, в котором у нас данные о численности    
5. Вычитаем из общей численности получившееся число. Так мы узнаём, сколько людей живёт в ИЖС всего  
6. Обновляем поле с численностью, воспользовавшись формулой из [п. 3](https://github.com/a-berez/QGIS-and-other/blob/main/QGIS_density.md#про-выражение)    

## 5. Построение тепловой карты  
1. С помощью инструмента «Centroids» создаём центроиды зданий  
2. Запускаем инструмент «Heatmap»

[1] — точечный слой полученный в п. 5.1 
[2] — радиус вокруг одной точки   
[3] — так как растровое изображение это, по сути своей, таблица из пикселей, нужно выбрать количество строк и столбцов в этой таблице. От этого же зависит и размер пикселя. Чем больше размер, тем «угловатее» изображение   
[4] — столбец, из которого будет браться «вес» точки  

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density8.png)  

Запускаем инструмент. Его работа может длиться достаточно долго.   

3. Чтобы не хранить тяжёлый растровый файл, можно воспользоваться инструментом «Contour Polygons», который создаёт полигоны в зависимости от значений растрового слоя  
[1] — растровый слой    
[2] — расстояние между изолиниями. Это расстояние нужно подобрать в зависимости от конкретных данных, но нужно аккуратно подходить к этому, потому что результат может серьезно измениться в зависимости от настроек. Если что, лишние уровни всегда можно скрыть настройков интервалов при визуализации  

![alt_text](https://github.com/a-berez/QGIS-and-other/blob/main/pics/density9.png)  

## 6. Визуализация   
В свойствах слоя выбираем символы, а там выбираем градиент. Настраиваем его. Границы настраиваемых полигонов лучше убирать.  
